var device,os,chats_api_url="/chat-plugin/portal/chats",send_api_url="/chat-plugin/portal/chat",device_api_url="/client/device",settings_api_url="/chat-plugin/setting",apk_download_prompt="We have an Android App for you to conveniently open the captive portal and to receive notifications. Click the download button below to install it. Disregard this message if you already installed it.",apk_link="/public/plugins/chat-plugin/assets/captive-portal.apk",mark_read_api_url="/chat-plugin/portal/mark-read",chatBoxOpened=!1,hide_portal_button=!1;function httpGet(url,cb){var xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&cb&&cb(xmlhttp.responseText)},xmlhttp.open("GET",url,!0),xmlhttp.send()}function httpPost(url,params,cb){var xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");xmlhttp.onload=function(){var data=xmlhttp.responseText;try{data=JSON.parse(xmlhttp.responseText)}catch(e){}cb&&cb(data)},xmlhttp.open("POST",url,!0),xmlhttp.setRequestHeader("Content-Type","application/json"),xmlhttp.send(JSON.stringify(params||{}))}function disconnected(){var ul,li;document.querySelector("li#disconnected")||(ul=document.querySelector(".conversation ul.list"),(li=document.createElement("li")).id="disconnected",li.style.textAlign="center",li.style.padding="20px",li.innerHTML="<a href='javascript:window.location.reload()'>Something went wrong? Click here to reload the page</a>",ul.append(li),scrollToBottom())}function reconnected(){var el=document.querySelector("li#disconnected");el&&el.remove()}function hasUnread(){document.querySelector(".unread-indicator").style.display=""}function hasRead(){return document.querySelector(".unread-indicator").style.display="none",httpGet(mark_read_api_url)}function initChatBox(){var textarea,twidth,el=document.querySelector(".chat-box");el&&(twidth=Math.min(450,window.innerWidth-20),textarea=Math.min(650,window.innerHeight-20),el.style.width=twidth+"px",el.style.height=textarea+"px",(textarea=document.querySelector(".chat-plugin .send-msg-con textarea")).style.width=(twidth=twidth-58)+"px",textarea.style.maxWidth=twidth+"px",textarea.style.minWidth=twidth+"px")}function resizeConversationCon(){document.querySelector(".chat-plugin .conversation").style.height="100%";var conv_con=document.querySelector(".chat-plugin .conversation"),send_msg_con=document.querySelector(".chat-plugin .send-msg-con");conv_con.style.height=conv_con.offsetHeight-(send_msg_con.offsetHeight+4)+"px"}var audio_url="/public/plugins/chat-plugin/assets/sounds/msg.mp3",audio=new Howl({src:[audio_url],loop:!1,buffer:!1,preload:!0});function openChatBox(){audio=audio||new Howl({src:[audio_url],loop:!1,buffer:!1,preload:!0}),document.querySelector(".main-icon").style.display="none",document.querySelector(".chat-box").style.display="",resizeConversationCon(),scrollToBottom(),chatBoxOpened=!0,hasRead();var msgr=document.getElementById("wh-widget-send-button");msgr&&(msgr.style.display="none")}function closeChatBox(){document.querySelector(".main-icon").style.display="",animateIcon(),document.querySelector(".chat-box").style.display="none",chatBoxOpened=!1;var msgr=document.getElementById("wh-widget-send-button");msgr&&(msgr.style.display="")}function notify(msg){if("undefined"!=typeof AndroidFunction&&AndroidFunction.showNotification&&AndroidFunction.showNotification(msg),!window.Notification)return!1;"granted"===Notification.permission?new Notification(msg):"denied"!==Notification.permission&&Notification.requestPermission().then(function(permission){"granted"===permission&&new Notification(msg)})}function animateIcon(with_sound){var icon=document.querySelector(".main-icon i.fa"),i=1,interval=setInterval(function(){i+=1,icon.style["font-size"]=i+"px",60<=i&&clearInterval(interval)},3);with_sound&&audio&&audio.play()}function formatDate(date){var hours=(date=new Date(date)).getHours(),minutes=date.getMinutes(),ampm_str=12<=hours?"PM":"AM",ampm_str=(hours=(hours%=12)||12)+":"+(minutes=minutes<10?"0"+minutes:minutes)+ampm_str;return[date.getMonth()+1,date.getDate(),date.getFullYear()].join("/")+" "+ampm_str}function capitalize(name){return name.substr(0,1).toUpperCase()+name.substr(1,name.length)}function scrollToBottom(el){(el=el||document.querySelector(".conversation")).scrollTop=el.scrollHeight}function formatChat(chat){var innerHTML,li=document.createElement("li");return li.id="message-"+chat.id,innerHTML=(innerHTML=(innerHTML=(innerHTML='<div class="message '+(chat.sender_id==device.id?"sent":"received")+'">')+'<strong class="sender">'+capitalize(chat.sender_id==device.id?"You ("+(device.hostname||device.mac_address)+")":chat.admin_username)+"</strong><br/>")+'<pre class="text">'+chat.message.trim()+"</pre>")+'<small class="time">'+formatDate(chat.created_at)+"</small></div>",li.innerHTML=innerHTML,li}function formatLoadMore(){var li=document.createElement("li");return li.innerHTML='<li><a class="message load-more" style="border-radius: 5px; display: inline-block; width: 100%; text-align: center;" onclick="loadMore(this)"><span class="text">Load more ...</span></a></li>',li}function mute(){var input=document.querySelector("#chat_message");input.title="Muted",input.disabled=!0}function unmute(){var input=document.querySelector("#chat_message");input.title="",input.disabled=!1}function initSettings(cb){httpGet(settings_api_url,function(data){(data=JSON.parse(data)).apk_download_prompt&&(apk_download_prompt=data.apk_download_prompt),data.apk_link&&(apk_link=data.apk_link),hide_portal_button=data.hide_portal_button,cb&&cb(data)})}var chats=[];function initChats(){var socket=Socket.getInstance();socket.disconnected&&disconnected(),socket.on("connection",function(){reconnected()}),socket.on("disconnect",function(){disconnected()}),socket.on("chat:mute",function(){mute(),reconnected()}),socket.on("chat:unmute",function(){unmute(),reconnected()}),httpGet(device_api_url,function(device_data){device=JSON.parse(device_data),httpGet(chats_api_url,function(data){var ul=document.querySelector(".conversation ul.list");data=JSON.parse(data),chats=data.chats,os=data.os,data.is_muted&&mute(),ul.innerHTML="";for(var i=0;i<chats.length;i++){var chat=chats[i];ul.prepend(formatChat(chat))}chats.length<data.total_count&&ul.prepend(formatLoadMore()),socket.on("chat",function(chat){var li=formatChat(chat);li.querySelector(".message").style.border="3px solid #5cb85b",li.classList.add("new-message"),ul.append(li),setTimeout(function(){li.querySelector(".message").style.border=""},1e3),setTimeout(function(){li.classList.remove("new-message")},3e3),setTimeout(function(){scrollToBottom()}),animateIcon(chat.sender_id!=device.id),setTimeout(function(){animateIcon()}),chat.sender_id!=device.id&&(notify(capitalize(chat.admin_username)+": "+chat.message),window.JSInterface&&window.JSInterface.messageReceived(chat.admin_username,chat.message)),(chatBoxOpened?hasRead:hasUnread)(),reconnected()}),0<=chats.findIndex(function(c){return!c.is_read_by_user})&&hasUnread()})}),setTimeout(function(){window.warning_sound&&window.JSInterface&&window.warning_sound.subscribe(function(megabytes){var seconds=megabytes.seconds||"",standalone_time=megabytes.standalone_time||"",megabytes=megabytes.megabytes||"";window.JSInterface.warning(seconds,standalone_time,megabytes)})},5e3)}var page=1,loading_more=!1;function loadMore(el){loading_more||(el&&el.remove&&el.remove(),loading_more=!0,httpGet(chats_api_url+"?page="+(page+=1)+"&ref="+Math.random(),function(data){loading_more=!1;var _chats=(data=JSON.parse(data)).chats;if(_chats&&!(_chats.length<=0)){chats=_chats.concat(chats);for(var ul=document.querySelector(".conversation ul.list"),i=0;i<_chats.length;i++){var chat=_chats[i];ul.prepend(formatChat(chat))}chats.length<data.total_count&&ul.prepend(formatLoadMore())}}))}function sendMessage(msg){msg.preventDefault();var input=document.querySelector("#chat_message"),msg=input.value;if(input.value="",msg)return httpPost(send_api_url,{message:msg},function(res){}),setTimeout(function(){document.querySelector(".new-message")||disconnected()},3e3),!1}function promptAppInstallation(){var ul,li,innerHTML;"android"==os&&"?ad"!=window.location.search&&(ul=document.querySelector(".conversation ul.list"),(li=document.createElement("li")).id="message-0",innerHTML='<div class="message received">',innerHTML='<div class="message received"><strong class="sender">Admin</strong><br/>',innerHTML=(innerHTML=(innerHTML='<div class="message received"><strong class="sender">Admin</strong><br/><pre class="text" style="padding-bottom: 0;margin-bottom: 0;">'+apk_download_prompt+"</pre>")+'<p style=" text-align: center; "><a style=" background: #209e91!important; color: white !important; padding: 10px; border-radius: 10px; display: inline-block; width: 210px; text-align: center; margin:10px;" href="'+apk_link+"?ref="+Math.random()+'">Download App</a></p>')+'<small class="time">'+formatDate(new Date)+"</small></div>",li.innerHTML=innerHTML,ul.append(li),hasUnread(),animateIcon(!0))}!function(){"use strict";setTimeout(function(){var chat_plugin;document.getElementById("chat-plugin")||((chat_plugin=document.createElement("div")).id="chat-plugin",httpGet("/public/plugins/chat-plugin/views/portal/chat.html?ref="+(new Date).getMonth(),function(html){chat_plugin.innerHTML=html,document.querySelector("body").append(chat_plugin)}))},1e3);var i=setInterval(function(){var socket=Socket.getInstance();document.querySelector(".chat-box")&&socket&&(initSettings(function(){return hide_portal_button?!(document.getElementById("chat-plugin").style.display="none"):(initChatBox(),initChats(),void animateIcon())}),clearInterval(i))},2e3);window.addEventListener("resize",function(){initChatBox(),chatBoxOpened&&(resizeConversationCon(),scrollToBottom(document.querySelector(".conversation")))})}();