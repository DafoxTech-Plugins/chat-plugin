function array_move(arr,old_index,new_index){if(new_index>=arr.length)for(var k=new_index-arr.length+1;k--;)arr.push(void 0);return arr.splice(new_index,0,arr.splice(old_index,1)[0]),arr}!function(){"use strict";angular.module("Plugins").component("contacts",{controller:"ContactsCtrl",templateUrl:"/public/plugins/chat-plugin/views/admin/contacts.html"}).controller("ContactsCtrl",function($scope,DevicesService,toastr,CatchHttpError,$timeout,ChatService,$ngConfirm,socket){socket=socket.getSocket();$scope.page=1,$scope.loadContacts=function(opts){$scope.page=1,$scope.has_more=!1,DevicesService.get(opts).then(function(data){data=data.data||{};$scope.devices=data.devices||[],$scope.$parent.has_unread=0<=_.findIndex($scope.devices,function(d){return d.has_unread}),$scope.has_more=0<data.devices.length&&data.total_count>$scope.devices.length})},$scope.loadMore=function(){$scope.page+=1;var opts={page:$scope.page,q:$scope.search};$scope.has_more=!1,DevicesService.get(opts).then(function(data){data=data.data||{};$scope.devices=$scope.devices.concat(data.devices),$scope.devices=_.uniq($scope.devices,function(d){return d.id}),$scope.has_more=0<data.devices.length&&data.total_count>$scope.devices.length})},$scope.loadContacts({page:$scope.page}),$scope.searchContacts=function(){$scope.loadContacts({page:$scope.page,q:$scope.search})},$scope.focusChat=function(contact){$scope.$parent.focusChat(contact),ChatService.markMessagesRead(contact.id).then(function(){contact.has_unread=!1,$scope.$parent.has_unread=0<=_.findIndex($scope.devices,function(d){return d.has_unread})})},$scope.messageAll=function(e){e.preventDefault(),$ngConfirm({title:"Confirm",content:"Are you sure you want to send this message to all your online customers?",escapeKey:"close",buttons:{ok:{text:"Yes",btnClass:"btn-danger",keys:["enter"],action:function(){var msg=angular.copy($scope.msg_all),sent=!1;$scope.sending=!0,ChatService.bulkSendToClients($scope.msg_all).then(function(res){sent=!0}).finally(function(){sent||($scope.msg_all=msg),$scope.sending=!1}),$scope.msg_all=""}},close:{text:"Cancel",keys:["escape"],btnClass:"btn-default"}}})},$scope.loadDevice=function(device_id){return DevicesService.getDeviceData(device_id).then(function(device){device=device.data;return 0<=_.findIndex($scope.devices,function(d){return d.id==device_id})||$scope.devices.unshift(device),device})};var audio=new Audio;audio.src="/public/plugins/chat-plugin/assets/sounds/msg2.mp3",audio.load(),socket.on("chat",function(chat){var dIndex;chat.sender_id&&(0<=(dIndex=_.findIndex($scope.devices,function(d){return d.id==chat.sender_id}))?($scope.devices[dIndex].has_unread=!0,$scope.devices=array_move($scope.devices,dIndex,0)):$scope.loadDevice(chat.sender_id).then(function(d){d.has_unread=!0}),$timeout(function(){$scope.$parent.has_unread=0<=_.findIndex($scope.devices,function(d){return d.has_unread})},500),audio.play(),$(".device-"+chat.mobile_device_id+" .unread-indicator").show())})})}();