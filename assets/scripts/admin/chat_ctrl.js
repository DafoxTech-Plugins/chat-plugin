!function(){"use strict";angular.module("Plugins").component("chats",{controller:"ChatsCtrl",templateUrl:"/public/plugins/chat-plugin/views/admin/chats.html",bindings:{contact:"="}}).controller("ChatsCtrl",function($scope,ChatService,DevicesService,toastr,CatchHttpError,$timeout,$ngConfirm,socket){function scrollToBottom(){$timeout(function(){var scroll=$(".conversation");scroll.animate({scrollTop:scroll.prop("scrollHeight")})}),$timeout(function(){$(".conversation .message").css("border","")},1500)}var socket=socket.getSocket(),_this=this;$scope.page=1;var loading_more=!(this.$doCheck=function(){var opts;_this.contact&&($scope.contact||{}).id!=_this.contact.id&&($scope.page=1,$scope.contact=angular.copy(_this.contact),opts={page:$scope.page},$scope.has_more=!1,ChatService.getClientMessages($scope.contact.id,opts).then(function(data){data=data.data||{};$scope.chats=(data.chats||[]).reverse(),$scope.has_more=data.total_count>$scope.chats.length,scrollToBottom()}).finally(function(){$scope.loadingMessages=!1}),DevicesService.getDeviceData($scope.contact.id).then(function(data){data=data.data||{};$scope.contact.is_muted=!!data.is_muted}))});$scope.loadMore=function(){var opts;loading_more||($scope.page+=1,opts={page:$scope.page},loading_more=!0,ChatService.getClientMessages($scope.contact.id,opts).then(function(chats){loading_more=!1;var data=chats.data||{},chats=(data.chats||[]).reverse().concat($scope.chats);$scope.chats=_.uniq(chats,function(i){return i.id}),$scope.has_more=data.total_count>$scope.chats.length}))},$scope.closeChat=function(){$scope.$parent.closeChat()},$scope.send=function(opts){opts.preventDefault();opts={message:$scope.msg};$scope.sending=!0,ChatService.sendToClient($scope.contact.id,opts).then(function(res){$scope.msg="",scrollToBottom()}).finally(function(){$scope.sending=!1})},$scope.deleteConversation=function(){$scope.chats.length<=0||$ngConfirm({title:"Confirm",content:"Are you sure you want to delete this conversation?",escapeKey:"close",buttons:{ok:{text:"Yes",btnClass:"btn-danger",keys:["enter"],action:function(){$scope.deleting=!0,ChatService.deleteConversation($scope.contact.id).then(function(res){$scope.chats=[],$scope.has_more=!1,$scope.page=1}).finally(function(){$scope.deleting=!1})}},close:{text:"Cancel",keys:["escape"],btnClass:"btn-default"}}})},$scope.muteDevice=function(device){return DevicesService.muteDevice(device.id).then(function(){device.is_muted=!0,toastr.success(device.hostname+" successfully muted")})},$scope.unmuteDevice=function(device){return DevicesService.unmuteDevice(device.id).then(function(){device.is_muted=!1,toastr.success(device.hostname+" successfully unmuted")})},socket.on("chat",function(chat){$(".conversation.device-"+chat.mobile_device_id+":visible").length&&(0<=_.findIndex($scope.chats,function(c){return c.id==chat.id})||($scope.chats.push(chat),scrollToBottom(),ChatService.markMessagesRead(chat.mobile_device_id).then(function(){$(".conversation .message:last:not(.placeholder)").css("border","5px solid #209e91"),$(`.conversation.device-${_this.contact.id}`).is(":visible")&&(_this.contact.has_unread=!1),$(".device-"+chat.mobile_device_id+" .unread-indicator").hide()})))})})}();