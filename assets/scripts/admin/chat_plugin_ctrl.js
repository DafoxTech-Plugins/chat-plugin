!function(){"use strict";$(document).on("keypress","textarea",function(e){13!=e.which||e.shiftKey||(e.preventDefault(),$(this).closest("form").submit())});$("#chat-plugin").length<=0&&$("body").append(`<div id='chat-plugin' ng-controller='ChatPluginCtrl'>
      <a href='javascript:void(0)' ng-click='toggleContacts()' class="main-icon fa {{showContacts ? 'fa-close' : 'fa-envelope-o'}}">
        <span class='fa fa-asterisk' ng-show='has_unread'></span>
      </a>
      <contacts ng-show="showContacts"></contacts>
      <chats ng-if="!!active_contact" contact="active_contact"></chats>
    </div>`),angular.module("Plugins").controller("ChatPluginCtrl",function($scope,toastr,CatchHttpError,$timeout){$scope.toggleContacts=function(){$scope.showContacts=!$scope.showContacts},$scope.focusChat=function(contact){$scope.active_contact=contact,$(".device-"+contact.id+" .unread-indicator").hide()},$scope.closeChat=function(){$scope.active_contact=null}}),angular.module("adopisoft").config(function($httpProvider){$httpProvider.interceptors.push("clientsLoadFilter")}).factory("clientsLoadFilter",function($q,$rootScope){return{request:function(d){return d},response:function(d){var url=((d||{}).config||{}).url||"";return d.data&&url.includes("/settings/clients")&&setTimeout(function(){var contactScope,list;(list=$("all-devices table tbody tr")).length&&(contactScope=angular.element(".contacts-bar").scope(),$.get("/chat-plugin/unread-device-ids").then(function(data){for(var i=0;i<list.length;i++){let tr=$(list[i]),td=tr.children().last();if(!td.children(".init-chat").length){let device=angular.element(tr).scope().c,chatBtn='<button class="btn btn-info btn-xs init-chat device-'+device.id+'" title="Chat"><i class="fa fa-envelope-o"></i>';var hasUnread=data.includes(device.id);chatBtn+='<i class="unread-indicator" style="display:'+(hasUnread?"inline":"none")+';position:absolute;color:red;font-size:30px;margin-top:-14px;">*</i>',chatBtn+="</button>",chatBtn=$(chatBtn),td.append(chatBtn),chatBtn.on("click",function(){$(this).children(".unread-indicator").hide();var _device=(_device=contactScope.devices.find(function(d){return d.id==device.id}))||device;contactScope.focusChat(_device)})}}}))}),d},responseError:function(rejection){return $q.reject(rejection)}}})}();